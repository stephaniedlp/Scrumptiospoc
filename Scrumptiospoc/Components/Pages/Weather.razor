@page "/home"
@page "/home/{paramId:guid}"
@layout Restaurant
@using Scrumptiospoc.Components.Layout
@using Scrumptiospoc.Interfaces;
@using Scrumptiospoc.Models;
@using System.Collections.ObjectModel
@inject IOrderInterface _orderservice;
@inject ILocationInterface _locationservice;
@rendermode InteractiveServer



<PageTitle>Order</PageTitle>

<h1>Orders</h1>
<button class="@((Location.IsActive ? "btn btn-primary" : "btn btn-danger"))" @onclick="OnlineBtn">@ButtonText</button>
<button class="@((Location.IsSlow ? "btn btn-warning" : "btn btn-primary"))" @onclick="SlowStatusBtn">Rush Hour: @Location.IsSlow</button>
<br />
<p>Total downtime is @Location.Downtime seconds </p>
<p>@Location.LastOffline</p>
<hr />

@if (Orders.Any())
{
    @foreach (var item in Orders.Where(w => w.Status != Status.NotSet))
    {
        <div class="mt-4">

            <p>@item.Id</p>
            <p>@item.Location?.Address</p>
            <p>@item.Status</p>
            @foreach (var prod in item.OrderItems)
            {
                <ol>@prod.Product.Name</ol>
                <ol>@prod.Product.Description</ol>
            }


            @if (item.Status == Status.IsSet)
            {
                <button class="btn btn-success" @onclick="() => Accept(item)">Accept</button>
                <button class="btn btn-danger" @onclick="() => Reject(item)">Reject</button>
            }
            @if (item.Status == Status.Accepted)
            {
                <button class="btn btn-primary" @onclick="() => Ready(item)">Ready</button>
                <button class="btn btn-danger" @onclick="() => Cancel(item)">Cancel</button>
            }
            @if (item.Status == Status.Finished)
            {
                <button class="btn btn-primary" @onclick="() => Delivered(item)">Delivered</button>
                <button class="btn btn-danger" @onclick="() => Cancel(item)">Cancel</button>
            }


        </div>
    }
}
else
{
    <p>No orders available.</p>
}



@code {
    [Parameter]
    public Guid paramId { get; set; }

    private string ButtonText = "Online";

    private ObservableCollection<Order> _orders = new();
    public ObservableCollection<Order> Orders
    {
        get => _orders;
        set
        {
            if (_orders != value)
            {

                _orders = value;
                StateHasChanged();
            }
        }
    }

    private Location _location = new();
    public Location Location
    {
        get => _location;
        set
        {
            if (_location != value)
            {

                _location = value;
                StateHasChanged();
            }
        }
    }
    protected override async Task OnInitializedAsync()
    {
        // Call the base method asynchronously
        await base.OnInitializedAsync();
        _orderservice.StateChanged += OnStateChanged;

        if (paramId != Guid.Empty)
        {
            RefreshOrders(paramId);
        }
        else
        {
            Orders = new();
        }



    }

    private async void RefreshOrders(Guid paramId)
    {
        Orders.Clear();
        Location = _locationservice.Locations.Where(w => w.Id == paramId).SingleOrDefault();

        var filteredOrders = Location.Orders;

        foreach (var order in filteredOrders)
        {
            Orders.Add(order);
        }

        StateHasChanged();
    }
    private void Accept(Order order)
    {
        _orderservice.AcceptOrder(order);
        NotifyStateChanged();
        OnStateChanged();
    }
    private void Reject(Order order)
    {
        _orderservice.RejectOrder(order);
        StateHasChanged();
    }
    private void Ready(Order order)
    {
        _orderservice.SetReadyOrder(order);
        StateHasChanged();
    }
    private void Delivered(Order order)
    {
        _orderservice.Delivered(order);
        StateHasChanged();
    }
    private void Cancel(Order order)
    {
        _orderservice.CancelOrder(order);
        StateHasChanged();
    }
    private void OnlineBtn()
    {
        Location = _locationservice.Locations.Where(w => w.Id == paramId).SingleOrDefault();
        _locationservice.OnOffLocation(Location);
        ButtonText = ButtonText == "Online" ? "Offline" : "Online";   
        StateHasChanged();
    }
    private void SlowStatusBtn() 
    {
        _locationservice.IsSlow(Location);
        StateHasChanged();
    }

    private void NotifyStateChanged()
    {
        StateChanged?.Invoke();
    }
    public event Action? StateChanged;
    private void OnStateChanged()
    {
        try
        {

            InvokeAsync(() =>
            {
                RefreshOrders(paramId);  // Update orders based on the new state
                StateHasChanged();  // Trigger a re-render
            });
        }
        catch (Exception ex)
        {

        }

    }

}
